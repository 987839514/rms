<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.report.dao.RentReportDao">
	<select id="rentReport" resultType="RentReport">
		<![CDATA[
			SELECT CONTRACT_CODE contractCode,p.PROJECT_NAME projectName,b.BUILDING_NAME buildingName,h.HOUSE_NO houseNo,
			r.ROOM_NO roomNo,ct.tenant_name tenantName,ct.cell_phone cellPhone,
			c.start_date startDate,c.EXPIRED_DATE expiredDate,c.RENTAL rental,
			c.CONTRACT_BUSI_STATUS rentType,u1.name saler,pt.TRADE_AMOUNT rentAmount,pt.create_date rentDate
			 FROM T_RENT_CONTRACT c
			LEFT JOIN T_PROPERTY_PROJECT p ON c.PROPERTY_PROJECT_ID=p.id
			LEFT JOIN T_BUILDING b ON c.BUILDING_ID=b.id
			LEFT JOIN T_HOUSE h ON c.HOUSE_ID=h.id
			LEFT JOIN T_ROOM r ON c.ROOM_ID=r.id
			LEFT JOIN (SELECT CONTRACT_ID,MAX(tenant_id) tenant_id,ten.tenant_name,ten.cell_phone FROM T_CONTRACT_TENANT
			LEFT JOIN T_TENANT ten ON tenant_id=ten.id
			 GROUP BY CONTRACT_ID) ct ON c.id=ct.CONTRACT_ID
			LEFT JOIN sys_user u1 ON c.USER_ID = u1.id
			LEFT JOIN T_PAYMENT_TRANS pt ON c.id=pt.TRANS_ID AND pt.PAYMENT_TYPE='9' 
			 WHERE c.CONTRACT_BUSI_STATUS IN('7','8','9','16')
		]]>
			<if test="propertyProject != null and propertyProject.id != null and propertyProject.id != ''">
				AND c.property_project_id = #{propertyProject.id}
			</if>
			<if test="building != null and building.id != null and building.id != ''">
				AND c.building_id = #{building.id}
			</if>
			<if test="house != null and house.id != null and house.id != ''">
				AND c.house_id = #{house.id}
			</if>
	</select>
	
	<!--<select id="">
		/*正常退租*/
		select r1.fee_date,r1.property_project_id,r1.counts,r2.counts,r3.counts,r4.counts,r5.counts from(
		select fee_date,property_project_id,COUNT(id) counts from(
		select CONCAT(YEAR(fee_date),LPAD(MONTH(fee_date),2,'0')) fee_date,t2.property_project_id,t2.id from(
		select a.rent_contract_id,MAX(a.fee_date) fee_date from t_accounting a
		group by a.rent_contract_id)t1 left join t_rent_contract t2 on t1.rent_contract_id=t2.id
		where t2.contract_busi_status='8') t group by fee_date,property_project_id)r1
		left join(
		/*定金违约*/
		select COUNT(id) counts,property_project_id,start_date from(
		select id,property_project_id,CONCAT(YEAR(start_date),LPAD(MONTH(start_date),2,'0')) start_date from(
		select id,property_project_id from t_deposit_agreement a where a.agreement_busi_status='1') t1 left join 
		(select trans_id,start_date from t_payment_trans ts where ts.payment_type='26') t2 on t1.id=t2.trans_id) t group by property_project_id,start_date) r2
		on r1.fee_date=r2.start_date and r1.property_project_id=r2.property_project_id
		left join(
		/*提前退租*/
		select fee_date,property_project_id,COUNT(id) counts from(
		select CONCAT(YEAR(fee_date),LPAD(MONTH(fee_date),2,'0')) fee_date,t2.property_project_id,t2.id from(
		select a.rent_contract_id,MAX(a.fee_date) fee_date from t_accounting a
		group by a.rent_contract_id)t1 left join t_rent_contract t2 on t1.rent_contract_id=t2.id
		where t2.contract_busi_status='7') t group by fee_date,property_project_id) r3
		on r1.fee_date=r3.fee_date and r1.property_project_id=r3.property_project_id
		left join(
		/*特殊退租*/
		select fee_date,property_project_id,COUNT(id) counts from(
		select CONCAT(YEAR(fee_date),LPAD(MONTH(fee_date),2,'0')) fee_date,t2.property_project_id,t2.id from(
		select a.rent_contract_id,MAX(a.fee_date) fee_date from t_accounting a
		group by a.rent_contract_id)t1 left join t_rent_contract t2 on t1.rent_contract_id=t2.id
		where t2.contract_busi_status='16') t group by fee_date,property_project_id)r4
		on r1.fee_date=r4.fee_date and r1.property_project_id=r4.property_project_id
		left join 
		/*出租*/
		(select CONCAT(YEAR(sign_date),LPAD(MONTH(sign_date),2,'0')) fee_date,property_project_id,COUNT(c.id) counts from t_rent_contract c
		where c.contract_busi_status='0'
		group by CONCAT(YEAR(sign_date),LPAD(MONTH(sign_date),2,'0')),property_project_id) r5 
		on r1.fee_date=r5.fee_date and r1.property_project_id=r5.property_project_id
		/*月末在租*/
		left join(
		select property_project_id,COUNT(id) counts from t_rent_contract c where contract_busi_status='0' and CONCAT(YEAR(start_date),LPAD(MONTH(start_date),2,'0'))<=r1.fee_date 
		and CONCAT(YEAR(expired_date),LPAD(MONTH(expired_date),2,'0'))>=r1.fee_date group by property_project_id) r6
		on r1.property_project_id=r6.property_project_id
	</select>-->
</mapper>